<% layout('/layouts/boilerplate')%>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="/css/campaigns.css">

<div class="campaign-header">
    <h1><i class="fas fa-rocket"></i> All Campaigns</h1>
    <a href="/MailMetrics/email" class="create-campaign-btn"><i class="fas fa-plus"></i> Create New Campaign</a>
</div>

<% if (allCampaigns.length === 0) { %>
    <h3 class="no-campaign-message">You haven't created any Campaigns yet!</h3>
<% } else { %>
    <div class="container">
        <div class="row">
            <% allCampaigns.forEach((campaign, i) => { %>

                <%# --- Logic Block for Calculations --- %>
                <%
                    const totalReceivers = campaign.receiver.length;
                    const totalViews = campaign.data.views.length;
                    const totalClicks = campaign.data.clicks.length;

                    // Calculate rates, preventing division by zero
                    const openRate = totalReceivers > 0 ? ((totalViews / totalReceivers) * 100).toFixed(0) : 0;
                    const clickRate = totalReceivers > 0 ? ((totalClicks / totalReceivers) * 100).toFixed(0) : 0;
                    
                    // Format the date, with a fallback if not sent
                    const sentDate = campaign.sendAt && campaign.sendAt.length > 0
                        ? new Date(campaign.sendAt[0]).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                        : 'Not Sent';
                %>

                <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                    <a href="/MailMetrics/campaigns/analyse/<%= campaign._id %>" class="listing-links">
                        <div class="card campaign-card h-100" style="--delay: <%= i %>">
                            
                            <div class="card-header">
                                <span class="card-title-text" title="<%= campaign.emailId.title %>">
                                    <%= campaign.emailId.title %>
                                </span>
                                <span class="card-status">
                                    Sent
                                </span>
                            </div>

                            <div class="card-body">
                                <p class="card-subject" title="<%= campaign.emailId.subject %>">
                                    <%= campaign.emailId.subject %>
                                </p>
                            </div>

                            <div class="card-metrics">
                                <div class="metric-group">
                                    <div class="metric-item">
                                        <div class="metric-details">
                                            <span class="label"><i class="fas fa-envelope-open-text"></i> Open Rate</span>
                                            <span class="raw-counts"><%= totalViews %> / <%= totalReceivers %> opens</span>
                                        </div>
                                        <span class="count"><%= openRate %>%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" style="width: <%= openRate %>%;"></div>
                                    </div>
                                </div>
                                <div class="metric-group" style="margin-top: 1rem;">
                                    <div class="metric-item">
                                        <div class="metric-details">
                                            <span class="label"><i class="fas fa-mouse-pointer"></i> Click Rate</span>
                                            <span class="raw-counts"><%= totalClicks %> / <%= totalReceivers %> clicks</span>
                                        </div>
                                        <span class="count"><%= clickRate %>%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" style="width: <%= clickRate %>%;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-footer">
                                <div class="footer-item" title="<%= campaign.emailId.sender %>">
                                    <i class="fas fa-user-circle"></i> 
                                    <span><%= campaign.emailId.sender.substring(0, 15) %>...</span>
                                </div>
                                <div class="footer-item">
                                    <i class="fas fa-calendar-alt"></i> 
                                    <span><%= sentDate %></span>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            <% }) %>
        </div>
    </div>
<% } %>